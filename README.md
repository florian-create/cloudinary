# Screenshot API Flask - D√©ploiement Render

API Flask pour g√©n√©rer des screenshots avec fl√®che rouge et upload automatique sur Cloudinary.

## D√©ploiement sur Render

### Option 1 : Via GitHub (Recommand√©)

1. **Cr√©er un repo GitHub** pour le dossier `flask-api/` :

```bash
cd ~/Desktop/mon-screenshot-api/flask-api
git init
git add .
git commit -m "Initial commit: Screenshot API Flask"
gh repo create screenshot-api-flask --public --source=. --push
```

2. **Connecter √† Render** :
   - Allez sur [render.com](https://render.com)
   - Cliquez "New +" ‚Üí "Web Service"
   - Connectez votre repo GitHub `screenshot-api-flask`
   - Render d√©tectera automatiquement `render.yaml`

3. **Configuration automatique** :
   - Name: `screenshot-api`
   - Environment: `Python 3`
   - Build Command: `pip install -r requirements.txt && pyppeteer-install`
   - Start Command: `gunicorn app:app`
   - Plan: **Free**

4. **D√©ployer** :
   - Cliquez "Create Web Service"
   - Attendre 5-10 minutes (installation de Chromium)
   - URL obtenue : `https://screenshot-api-xxxx.onrender.com`

### Option 2 : D√©ploiement direct

```bash
# Installer Render CLI
npm install -g render-cli

# Se connecter
render login

# D√©ployer
render deploy
```

## Utilisation dans Clay

Une fois d√©ploy√© sur Render, vous aurez une URL comme :
```
https://screenshot-api-xxxx.onrender.com
```

### Configuration Clay - HTTP API

1. **Dans votre table Clay**, ajoutez une colonne **HTTP API**

2. **Configuration** :

```
Method: GET
URL: https://screenshot-api-xxxx.onrender.com/api/generate
```

3. **Query Parameters** :

| Key | Value |
|-----|-------|
| `url` | `{{Company domain}}` |

4. **Advanced Settings** :
   - Timeout: `60 seconds` (important, g√©n√©ration prend du temps)
   - Retry on failure: ‚úÖ Activ√©
   - Cache results: ‚úÖ Activ√©

5. **Run** sur une ligne de test

6. **R√©ponse attendue** :

```json
{
  "success": true,
  "url": "https://example.com",
  "screenshot_url": "https://res.cloudinary.com/dqfnvegv2/image/upload/v1/screenshots/example-com.jpg",
  "message": "Screenshot generated and uploaded successfully"
}
```

### Mapper la r√©ponse dans Clay

Dans la colonne **URL screen** (ou cr√©er une nouvelle colonne) :

**Option A : Utiliser le r√©sultat direct de l'HTTP API**

Clay devrait automatiquement extraire `screenshot_url` de la r√©ponse.

**Option B : Formule pour extraire** (si besoin)

Si Clay retourne tout le JSON, cr√©ez une colonne Formula :

```javascript
// Extraire screenshot_url de la r√©ponse HTTP API
const response = {{HTTP API Response}};
return response.screenshot_url;
```

## Test local (avant d√©ploiement)

```bash
cd ~/Desktop/mon-screenshot-api/flask-api

# Cr√©er un environnement virtuel
python3 -m venv venv
source venv/bin/activate

# Installer les d√©pendances
pip install -r requirements.txt
pyppeteer-install

# Lancer l'API
python app.py
```

Tester :
```bash
curl "http://localhost:5000/api/generate?url=https://example.com"
```

## Endpoints disponibles

### GET /api/generate

G√©n√®re un screenshot avec fl√®che et upload sur Cloudinary.

**Param√®tres** :
- `url` (required) : URL du site √† screenshoter

**Exemple** :
```
GET /api/generate?url=https://example.com
```

**R√©ponse** :
```json
{
  "success": true,
  "url": "https://example.com",
  "screenshot_url": "https://res.cloudinary.com/dqfnvegv2/image/upload/v1/screenshots/example-com.jpg",
  "message": "Screenshot generated and uploaded successfully"
}
```

### GET /health

Health check de l'API.

**R√©ponse** :
```json
{
  "status": "ok"
}
```

## Configuration

Les param√®tres de la fl√®che et du cercle sont dans `app.py` ligne 19 :

```python
CONFIG = {
    'arrow': {
        'startX': 85,  # Position de d√©part
        'endX': 60,    # O√π la fl√®che pointe
        'width': 20    # √âpaisseur
    },
    'circle': {
        'radius': 80   # Taille du cercle
    }
}
```

## Co√ªts

- **Render (Plan Free)** : Gratuit
  - 750h/mois
  - Se met en veille apr√®s 15min d'inactivit√©
  - Premier appel peut prendre 30s (cold start)

- **Cloudinary** : Gratuit (25GB stockage)

**Total : 0‚Ç¨**

## Troubleshooting

### Timeout sur Clay

Si vous avez des timeouts :
1. Augmenter le timeout Clay √† 90 secondes
2. Le premier appel est lent (cold start Render)
3. Les appels suivants sont plus rapides

### Screenshot vide

V√©rifiez les logs Render :
- Dashboard ‚Üí Votre service ‚Üí Logs
- Chercher les erreurs Python

### Render ne d√©marre pas

V√©rifiez que `pyppeteer-install` est dans le build command.

## Mise √† jour

Pour mettre √† jour apr√®s modifications :

```bash
git add .
git commit -m "Update: am√©lioration de la fl√®che"
git push
```

Render red√©ploie automatiquement !

## S√©curit√© (Optionnel)

Pour prot√©ger votre API avec une cl√© :

1. Ajouter dans Render : Environment Variables
   - `API_KEY` = `votre-cl√©-secr√®te`

2. Modifier `app.py` :

```python
@app.route('/api/generate', methods=['GET'])
def generate_screenshot():
    api_key = request.headers.get('X-API-Key')
    if api_key != os.environ.get('API_KEY'):
        return jsonify({'error': 'Unauthorized'}), 401
    # ... rest of code
```

3. Dans Clay, ajouter un Header :
   - Key: `X-API-Key`
   - Value: `votre-cl√©-secr√®te`

---

**Pr√™t √† d√©ployer !** üöÄ
